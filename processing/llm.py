from openai import OpenAI

import asyncio
import logging
import re

client = OpenAI(
    base_url="",
    api_key="",
)

SYSTEM_PROMPT = {
    "role": "system",
    "content": """Тебе будут отправляться тексты чеков, квитанций или платёжных уведомлений.
Твоя задача:
Найти все упоминания сумм в следующих валютах:
¥ (если текст на китайском языке — трактовать как юань);
$ (доллары США);
₽ или текстовое обозначение "руб." (российские рубли).
Извлечь числовые значения сумм (целые числа или числа с плавающей запятой/точкой).
Если сумма отрицательная, необходимо отбросить знак минус и учитывать её как положительную.
Структура текста:
Каждый чек ограничен символами "O" в начале и в конце (эти символы являются только маркерами и не являются частью текста чека).
Правила обработки данных:
Каждый чек обрабатывается отдельно, независимо от других чеков.
Внутри одного чека:
Если встречаются разные валюты, учитывать только одну валюту — ту, которая первая встретится в чеке.
Все суммы в других валютах полностью игнорировать.
При подсчёте сумм:
***Игнорировать повторы одной и той же суммы.
Игнорировать текстовые пояснения, даты, имена отправителей и получателей — учитывать только суммы.
Формат вывода:
Для каждого валидного чека выводить отдельный блок результата.
Формат записи:
{Итоговая сумма с двумя знаками после запятой}{символ валюты}
Никакие другие валюты (даже с нулевой суммой) в ответе не упоминать.
***Строго соблюдать формат ответа без каких-либо отклонений, даже в случае сомнений.
Примеры правильного вывода:
Вход: 
O
12:43
Done
Payment success
¥1920.00
Svetlana        ¥1920.00
Payment method  Balance
Translate
O

Вывод:
¥1920.00

Вход:
O
*珍向*玉玲转帐 子回单专用章     ¥12000.00
14:38 0 0
转账详情
中国农业银行股份有限公司
付款人  *珍
付款账户        6228****6418
收款人  *玉玲
收款账户        6013****3518
收款银行        中国银行
转账金额        12000.00元
交易时间        2025-04-17 14:32:07
转账附言
此回单为付款人生成，表示汇款申请已提交，资金到账状态
以您收款账户实际情况为准。
O

Вывод:
¥12000.00

Вход:
O
陈璟如
-100,000.00
交易成功
支付时间        2025-04-1714:39:59
款方式  账户余额
品说明  收钱码收款
款方全称        **如（个人）
「单号  2025041722001400091413974159
家订单号        47448719583042074000094
单管理
为您统计了最近的花费趋势，去看看分析吧～
单分类  商业服务〉
签和备注        加
入收支
O

Вывод:
¥100000.00

Вход:
O
ТИНЬКОФФ
17.06.2022 12:14:57
Итого   12 000 ₽
Перевод По номеру телефона
Статус  Успешно
Сумма   12 000 ₽
Отправитель     Александр
Телефон получателя
Получатель      Ольга П.
АО «ТИНЬКОФФ БАНК»
БИК 044525974 ИНН 7710140679
К/С 30101810145250000974
O

Вывод: 12000 ₽

Вход:
O
19:16 Ouis      uIl 39%
18 июля 2020, 13:25
Кирилл Н.
Переводы
- 1 000,00₽
亡
ВЫСЛАТЬ ЧЕК     ДОБАВИТЬ В      ПОВТОРИТЬ
ИЗБРАННОЕ       ПЛАТЕЖ
Перевод
Счет Tinkoff Black      ₽
Реквизиты
По номеру телефона
+7.     99
По номеру карты
Тинькофф Банк
O

Вывод: 
1000 ₽

Кратко:
Условие	Действие
В чеке только одна валюта или первая найденная - Считаем суммы только этой валюты
Остальные валюты в чеке - Игнорируем полностью
Вывод - Только итог по выбранной валюте
"""
}


async def ask_llm(user_message: str):
    completion = await asyncio.to_thread(client.chat.completions.create,
        extra_body={},
        model=Const.MODEL,
        # temperature=0.0,
        messages=[
            SYSTEM_PROMPT,
            {"role": "user", "content": user_message}
        ]
    )
    return completion.choices[0].message.content


if __name__ == "__main__":
    result = asyncio.run(ask_llm("""
O
12:43
Done
Payment success
¥1920.00
Svetlana        ¥1920.00
Payment method  Balance
Translate
O
                                 
O
*珍向*玉玲转帐 子回单专用章     ¥12000.00
14:38 0 0
转账详情
中国农业银行股份有限公司
付款人  *珍
付款账户        6228****6418
收款人  *玉玲
收款账户        6013****3518
收款银行        中国银行
转账金额        12000.00元
交易时间        2025-04-17 14:32:07
转账附言
此回单为付款人生成，表示汇款申请已提交，资金到账状态
以您收款账户实际情况为准。
O

O
6O
陈璟如
-100,000.00
交易成功
支付时间        2025-04-1714:39:59
款方式  账户余额
品说明  收钱码收款
款方全称        **如（个人）
「单号  2025041722001400091413974159
家订单号        47448719583042074000094
单管理
为您统计了最近的花费趋势，去看看分析吧～
单分类  商业服务〉
签和备注        加
入收支
O"""))

    print(result)